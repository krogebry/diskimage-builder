{"AWSTemplateFormatVersion":"2010-09-09","Description":"Base bits","Parameters":{"BuildId":{"Type":"String","Description":"Build identifier"},"broker-instance_type":{"Type":"String","Default":"m1.small","Description":"log-stash broker instance type"}},"Resources":{"CfnUser":{"Type":"AWS::IAM::User"},"BuildKeys":{"Type":"AWS::IAM::AccessKey","Properties":{"UserName":{"Ref":"CfnUser"}}},"WaitHandle":{"Type":"AWS::CloudFormation::WaitConditionHandle"},"log_stash-broker":{"Type":"AWS::EC2::Instance","Metadata":{"AWS::CloudFormation::Init":{"config":{"packages":{"apt":{"mysql-server":[]}}}}},"Properties":{"ImageId":{"Fn::Join":["-",["broker",{"Ref":"BuildId"}]]},"KeyName":{"Fn::Join":["-",["key",{"Ref":"BuildId"}]]},"InstanceType":{"Ref":"broker-instance_type"},"UserData":{"Fn::Base64":{"Fn::Join":["",["#!/bin/bash -v\n","# Helper function\n","function error_exit\n","{\n","  /opt/aws/bin/cfn-signal -e 1 -r \"$1\" '",{"Ref":"WaitHandle"},"'\n","  exit 1\n","}\n","/opt/aws/bin/cfn-init -s ",{"Ref":"AWS::StackName"}," -r WikiDatabase "," --access-key ",{"Ref":"BuildKeys"}," --secret-key ",{"Fn::GetAtt":["BuildKeys","SecretAccessKey"]}," --region ",{"Ref":"AWS::Region"}," || error_exit 'Failed to run cfn-init'\n","# All is well so signal success\n","/opt/aws/bin/cfn-signal -e 0 -r \"log_stash broker server setup complete\" '",{"Ref":"WaitHandle"},"' (",{"Ref":"BuildId"},")\n"]]}}}}},"Outputs":{}}
